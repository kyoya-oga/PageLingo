# 要件定義書

## 概要

PageLingoは、iOS Safari、macOS Safari、およびGoogle ChromeでWebページの可視テキストをLLMで全文翻訳するブラウザ拡張機能です。速度優先（Fast）と品質優先（Quality+）の二段階翻訳アプローチを採用し、ワンクリックまたは自動でWebページを翻訳します。

## 要件

### 要件1

**ユーザーストーリー:** Webユーザーとして、ワンクリックでWebページを翻訳したい。外国語のコンテンツを素早く理解できるようになるため。

#### 受け入れ基準

1. ユーザーが翻訳ボタンをクリックしたとき、システムは現在のビューポート（画面に表示されている部分）からテキストを抽出し、優先的に翻訳する
2. ユーザーがスクロールして新しいコンテンツがビューポートに入ったとき、システムはIntersection Observerを使用してそのテキストを検出し、翻訳する
3. テキスト抽出が完了したとき、システムはデフォルトでFastモード（gpt-5-mini）を使用してコンテンツを翻訳する
4. 翻訳が完了したとき、システムはHTML構造を保持しながら元のテキストを翻訳されたテキストに置き換える
5. ページに動的コンテンツが含まれている場合、システムはMutationObserverを介して新しいコンテンツを検出し、ビューポートに入った時点で翻訳する

### 要件2

**ユーザーストーリー:** 高品質な翻訳が必要なユーザーとして、自動品質アップグレードシステムが欲しい。手動介入なしに重要なコンテンツがより良い翻訳を得られるため。

#### 受け入れ基準

1. Fastモード翻訳が完了したとき、システムはヒューリスティック指標を使用して翻訳品質を分析する
2. 長さ比が0.6未満または1.6を超える場合、システムはQuality+モード再翻訳をトリガーする
3. 句読点や文数が大幅に異なる場合、システムはQuality+モード再翻訳をトリガーする
4. 数字やURLが翻訳で失われた場合、システムはQuality+モード再翻訳をトリガーする
5. 用語集の用語が適切に翻訳されていない場合、システムはQuality+モード再翻訳をトリガーする
6. Quality+再翻訳がトリガーされたとき、システムはmedium effortの設定でgpt-5モデルを使用する

### 要件3

**ユーザーストーリー:** ユーザーとして、選択したテキスト部分を手動で再翻訳したい。特定のセクションの翻訳エラーを修正できるため。

#### 受け入れ基準

1. ユーザーが翻訳されたページでテキストを選択したとき、システムはコンテキストメニューオプション「再翻訳（選択範囲）」を表示する
2. ユーザーが再翻訳オプションをクリックしたとき、システムは選択範囲を一時的にハイライトする
3. 再翻訳が要求されたとき、システムは選択されたテキストにQuality+モードを使用する
4. 再翻訳が完了したとき、システムは選択されたテキストのみを新しい翻訳に置き換える
5. ユーザーがAlt+Shift+Rを押した場合、システムは現在選択されているテキストを再翻訳する

### 要件4

**ユーザーストーリー:** ユーザーとして、翻訳設定を構成したい。自分のニーズに合わせて拡張機能の動作をカスタマイズできるため。

#### 受け入れ基準

1. ユーザーが拡張機能のポップアップを開いたとき、システムは言語選択とFast/Qualityモード切り替えを表示する
2. ユーザーがオプションページを開いたとき、システムはAPIプロバイダー設定と用語集管理の設定を提供する
3. ユーザーが用語集の用語を追加したとき、システムはそれらをローカルに保存し、翻訳の一貫性のために使用する
4. ユーザーがサイト固有の設定を構成したとき、システムはそれらを記憶し、今後の訪問に適用する
5. ユーザーがSafari iOSを使用している場合、システムはセキュリティのためにKeychainに機密設定を保存する

### 要件5

**ユーザーストーリー:** 開発者として、拡張機能がエラーを適切に処理することを望む。ユーザーが信頼できる翻訳体験を得られるため。

#### 受け入れ基準

1. APIリクエストが失敗したとき、システムは最大3回の再試行で指数バックオフを実装する
2. 翻訳が空または明らかに間違った結果を返したとき、システムはQuality+モードで1回再試行する
3. レート制限に達したとき、システムはリクエストをキューに入れ、サイト固有のレート制限を尊重する
4. 部分翻訳が失敗したとき、システムは失敗したセグメントをスキップし、成功したものを続行する
5. ユーザーが翻訳をキャンセルしたとき、システムはすべての保留中のリクエストを停止し、変更を元に戻す

### 要件6

**ユーザーストーリー:** プライバシーを気にするユーザーとして、データが安全に処理されることを望む。ブラウジングコンテンツがプライベートに保たれるため。

#### 受け入れ基準

1. APIキーを保存するとき、システムは拡張機能にハードコードしない
2. Safariを使用しているとき、システムはネイティブKeychainに機密データを保存する
3. 翻訳のためにコンテンツを送信するとき、システムはビューポートコンテンツを優先してデータを最小化する
4. 権限を要求するとき、システムはオプションのホスト権限で最小限の必要な権限を使用する
5. アプリストアに提出するとき、システムはデータ送信を明確に開示し、ユーザーの同意を要求する

### 要件7

**ユーザーストーリー:** ユーザーとして、拡張機能がChromeとSafariの両方のプラットフォームで動作することを望む。ブラウザの選択に関係なく使用できるため。

#### 受け入れ基準

1. Chrome用にビルドするとき、システムはZIPファイルとしてMV3拡張パッケージを作成する
2. Safari用にビルドするとき、システムはxcrun safari-web-extension-converterを使用してXcodeプロジェクトを作成する
3. iOS Safariで実行するとき、システムはApp Store配布用のコンテナアプリを含む
4. macOS Safariで実行するとき、システムはiOSとmacOSの両方のバージョンをサポートする
5. 配布するとき、システムはChrome Web StoreとSafari App Storeの提出をサポートする

### 要件8

**ユーザーストーリー:** ユーザーとして、拡張機能が重要なコンテンツ要素を保持することを望む。翻訳されたページが機能的で読みやすいままであるため。

#### 受け入れ基準

1. テキストを抽出するとき、システムはSCRIPT、STYLE、PRE、CODE、KBD、SAMP要素を除外する
2. テキストを抽出するとき、システムはcontenteditable、aria-hidden、.notranslate、またはtranslate="no"属性を持つ要素を除外する
3. 翻訳するとき、システムは数字、URL、インラインコードマーカーを元の形で保持する
4. テキストを置き換えるとき、システムはテキストノードのみを変更し、すべてのHTMLタグと属性を保持する
5. 大きなページを処理するとき、システムは効率的な処理のためにコンテンツを2-4k文字のバッチにチャンク化する

### 要件9

**ユーザーストーリー:** コスト意識のあるユーザーとして、不要なトークン消費を避けたい。翻訳コストを最小限に抑えられるため。

#### 受け入れ基準

1. システムが翻訳を開始するとき、ビューポート内のコンテンツを最優先で処理する
2. ユーザーがスクロールしてコンテンツがビューポートに入ったとき、システムはIntersection Observerを使用して遅延翻訳を実行する
3. システムがページを離れる際、未翻訳のコンテンツがある場合は翻訳リクエストをキャンセルする
4. システムが同じページを再訪問したとき、以前に翻訳されたコンテンツをキャッシュから復元し、新しい翻訳リクエストを避ける
5. システムが非表示または折りたたまれた要素を検出したとき、それらの翻訳を遅延し、表示されるまで待機する