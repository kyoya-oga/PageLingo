# 実装計画

- [ ] 1. プロジェクト構造とコア インターフェースの設定
  - Chrome MV3 と Safari Web Extension の基本ディレクトリ構造を作成
  - TypeScript 設定とビルドシステムを構築
  - 基本的なマニフェストファイル（manifest.json）を作成
  - _要件: 7.1, 7.2, 7.3_

- [ ] 2. データモデルとインターフェースの実装
  - [ ] 2.1 基本データ構造の定義
    - TextSegment、TranslatedSegment、QualityScore インターフェースを実装
    - TranslationRequest、StorageSchema の型定義を作成
    - _要件: 8.4, 1.1_
  
  - [ ] 2.2 Translation Provider インターフェースの実装
    - TranslationProvider 基底インターフェースを定義
    - OpenAIProvider クラスの基本構造を実装
    - API リクエスト/レスポンス処理のユーティリティを作成
    - _要件: 2.6, 5.1_

- [ ] 3. Content Script の基本機能実装
  - [ ] 3.1 テキスト抽出エンジンの実装
    - TreeWalker を使用した DOM テキスト抽出機能を実装
    - 除外要素の判定ロジック（SCRIPT, STYLE, PRE, CODE等）を実装
    - テキストセグメントの生成とノードパス記録機能を実装
    - _要件: 8.1, 8.2, 1.1_
  
  - [ ] 3.2 ビューポート管理システムの実装
    - Intersection Observer を使用したビューポート監視を実装
    - 要素の優先度付けとキューイングシステムを実装
    - 遅延翻訳のトリガー機能を実装
    - _要件: 1.2, 9.1, 9.2_
  
  - [ ] 3.3 テキスト置換エンジンの実装
    - テキストノードの安全な置換機能を実装
    - HTML 構造保持のための検証機能を実装
    - 一時的なハイライト表示機能を実装
    - _要件: 1.3, 8.4, 3.2_

- [ ] 4. Background/Service Worker の実装
  - [ ] 4.1 翻訳管理システムの実装
    - 翻訳リクエストのキューイングと並列処理を実装
    - バッチ処理とチャンク化機能を実装
    - リクエストのキャンセルと優先度管理を実装
    - _要件: 8.5, 9.3, 5.5_
  
  - [ ] 4.2 品質分析エンジンの実装
    - 長さ比、句読点、数値/URL 保持の分析機能を実装
    - 用語集コンプライアンス チェック機能を実装
    - Quality+ モード自動アップグレードの判定ロジックを実装
    - _要件: 2.1, 2.2, 2.3, 2.4, 2.5_
  
  - [ ] 4.3 エラーハンドリングとレート制限の実装
    - 指数バックオフによる再試行機能を実装
    - サイト別レート制限管理を実装
    - エラー分類と復旧戦略を実装
    - _要件: 5.1, 5.2, 5.3, 5.4_

- [ ] 5. Translation Provider の実装
  - [ ] 5.1 OpenAI Provider の実装
    - GPT-5-mini（Fast）と GPT-5（Quality+）の API 統合を実装
    - JSON レスポンス形式の検証と解析を実装
    - プロンプト テンプレートとシステムメッセージを実装
    - _要件: 2.6, 8.3_
  
  - [ ] 5.2 レスポンス検証とエラーハンドリング
    - API レスポンスの構造検証を実装
    - 無効なレスポンスの検出と再試行ロジックを実装
    - レート制限とクォータ管理を実装
    - _要件: 5.2, 5.3_

- [ ] 6. 選択範囲再翻訳機能の実装
  - [ ] 6.1 選択範囲検出システムの実装
    - テキスト選択の検出とセグメント化を実装
    - コンテキストメニューの統合を実装
    - キーボードショートカット（Alt+Shift+R）の処理を実装
    - _要件: 3.1, 3.5_
  
  - [ ] 6.2 選択範囲翻訳処理の実装
    - 選択されたテキストの Quality+ モード翻訳を実装
    - 一時的なハイライト表示を実装
    - 選択範囲のみの置換機能を実装
    - _要件: 3.2, 3.3, 3.4_

- [ ] 7. UI コンポーネントの実装
  - [ ] 7.1 Popup UI の実装
    - 言語選択ドロップダウンを実装
    - Fast/Quality+ モード切り替えを実装
    - 翻訳開始/停止ボタンと状態表示を実装
    - _要件: 4.1_
  
  - [ ] 7.2 Options ページの実装
    - API プロバイダー設定画面を実装
    - 用語集管理インターフェースを実装
    - サイト別設定とキャッシュ管理を実装
    - _要件: 4.2, 4.3, 4.4_

- [ ] 8. ストレージとキャッシュシステムの実装
  - [ ] 8.1 設定管理システムの実装
    - ユーザー設定の保存と読み込み機能を実装
    - サイト別設定の管理を実装
    - 用語集の永続化を実装
    - _要件: 4.3, 4.4_
  
  - [ ] 8.2 翻訳キャッシュシステムの実装
    - 翻訳結果のキャッシュ機能を実装
    - LRU ベースのキャッシュ削除を実装
    - キャッシュの復元と再利用機能を実装
    - _要件: 9.4_

- [ ] 9. セキュリティとプライバシー機能の実装
  - [ ] 9.1 データ保護機能の実装
    - 機密情報の自動検出と除外機能を実装
    - コンテンツ送信の最小化機能を実装
    - ユーザー同意管理システムを実装
    - _要件: 6.3, 6.4, 6.5_
  
  - [ ] 9.2 Safari Keychain 統合の実装
    - iOS/macOS での Keychain API 統合を実装
    - Native messaging による設定同期を実装
    - 暗号化された設定保存を実装
    - _要件: 4.5, 6.2_

- [ ] 10. プラットフォーム固有の実装
  - [ ] 10.1 Chrome MV3 対応の実装
    - Service Worker としての Background Script を実装
    - MV3 権限システムの統合を実装
    - Chrome Web Store 提出用パッケージングを実装
    - _要件: 7.1_
  
  - [ ] 10.2 Safari Web Extension 対応の実装
    - xcrun safari-web-extension-converter での変換設定を実装
    - iOS/macOS コンテナアプリの基本構造を実装
    - Safari App Store 提出用の設定を実装
    - _要件: 7.2, 7.3, 7.4_

- [ ] 11. テストスイートの実装
  - [ ] 11.1 単体テストの実装
    - TextExtractor, QualityAnalyzer, TranslationProvider のテストを実装
    - DOM 操作とテキスト置換のテストを実装
    - エラーハンドリングとレート制限のテストを実装
    - _要件: 全要件の検証_
  
  - [ ] 11.2 統合テストの実装
    - End-to-end 翻訳フローのテストを実装
    - ビューポートベース遅延翻訳のテストを実装
    - 選択範囲再翻訳のテストを実装
    - _要件: 1.2, 3.1-3.5, 9.2_

- [ ] 12. パフォーマンス最適化の実装
  - [ ] 12.1 ビューポート最適化の実装
    - Intersection Observer の最適化を実装
    - 翻訳優先度システムの調整を実装
    - メモリ使用量の最適化を実装
    - _要件: 9.1, 9.2, 9.5_
  
  - [ ] 12.2 バッチ処理最適化の実装
    - 並列リクエスト数の動的調整を実装
    - チャンクサイズの最適化を実装
    - API レスポンス時間の監視と調整を実装
    - _要件: 8.5, 5.3_

- [ ] 13. 最終統合とデバッグ
  - [ ] 13.1 クロスブラウザ互換性テスト
    - Chrome での動作確認とデバッグを実行
    - Safari（iOS/macOS）での動作確認とデバッグを実行
    - 異なる Web サイトでの動作テストを実行
    - _要件: 7.1-7.5_
  
  - [ ] 13.2 本番環境準備
    - 本番用ビルド設定の最適化を実装
    - アプリストア提出用のメタデータとスクリーンショットを準備
    - ユーザードキュメントとプライバシーポリシーを作成
    - _要件: 6.5_